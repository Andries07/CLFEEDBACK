<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Customer Feedback Kiosk</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<style>
  :root{
    --veil: rgba(255,255,255,.92);
    --accent:#f97316; --good:#16a34a; --warn:#eab308; --bad:#dc2626;
  }
  html,body{margin:0;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .hero{min-height:100dvh;background:url('./background.jpg') center/cover no-repeat fixed;display:grid;place-items:center}
  .wrap{width:min(1100px,94vw);background:var(--veil);border-radius:20px;padding:clamp(14px,3vw,28px);box-shadow:0 12px 40px rgba(0,0,0,.25)}
  h1{margin:0 0 8px 0;font-weight:800}
  .subtitle{color:#444;margin-bottom:14px}
  .q{margin:12px 0 18px}
  .q-label{font-weight:700;margin-bottom:8px}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:740px){.grid{grid-template-columns:repeat(2,1fr)}}
  .choice{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 10px;background:#fff;border:2px solid #ddd;border-radius:14px;cursor:pointer;min-height:64px;text-align:center}
  .choice input{display:none}
  .choice[data-score="5"].active{border-color:var(--good);box-shadow:0 0 0 3px rgba(22,163,74,.15) inset}
  .choice[data-score="4"].active{border-color:#22c55e}
  .choice[data-score="3"].active{border-color:var(--warn);box-shadow:0 0 0 3px rgba(234,179,8,.15) inset}
  .choice[data-score="2"].active,.choice[data-score="1"].active{border-color:var(--bad);box-shadow:0 0 0 3px rgba(220,38,38,.12) inset}
  .emoji{font-size:26px}
  .label{font-weight:700}
  .card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  input[type=text],textarea{width:100%;padding:12px;border:1.6px solid #ddd;border-radius:12px;font-size:16px;background:#fff}
  textarea{min-height:90px;resize:vertical}
  .ck{display:flex;align-items:flex-start;gap:10px}.ck input{margin-top:4px}
  .actions{display:flex;gap:12px;margin-top:16px;align-items:center}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:14px;padding:14px 18px;font-weight:800;font-size:18px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:#666;font-size:14px}
  .thanks{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.66)}
  .thanks .inner{background:#fff;padding:24px;border-radius:18px;text-align:center;width:min(480px,92vw);box-shadow:0 16px 50px rgba(0,0,0,.4)}
  .footer{margin-top:8px;color:#444;font-size:14px;text-align:center}
  #netbadge{position:fixed;right:12px;bottom:12px;background:#0a7d24;color:#fff;padding:6px 10px;border-radius:999px;font:12px system-ui;opacity:.95;z-index:9999}
</style>
</head>
<body>
  <div class="hero">
    <div class="wrap">
      <h1>Quick Service Feedback</h1>
      <div class="subtitle">Please tap one answer per question.</div>

      <div id="questions"></div>

      <div class="card" style="margin-top:16px">
        <h3>Optional details</h3>
        <div class="row">
          <input id="name" type="text" placeholder="Name (optional)">
          <input id="surname" type="text" placeholder="Surname (optional)">
        </div>
        <div class="row" style="margin-top:10px">
          <input id="phone" type="text" placeholder="Phone (optional)">
          <textarea id="feedback" placeholder="Additional feedback (optional)"></textarea>
        </div>
        <div class="ck" style="margin-top:10px">
          <input id="popia" type="checkbox">
          <label for="popia">I consent to the collection and processing of my personal information for customer service and quality feedback purposes, in accordance with the POPIA.</label>
        </div>
        <div class="muted" style="margin-top:6px">You don’t need to share personal details. If you do, ticking consent is required.</div>
      </div>

      <div class="actions">
        <button id="submitBtn" class="btn" disabled>Submit</button>
        <div class="muted" id="statusTxt"></div>
      </div>

      <div class="footer" id="footer"></div>
    </div>
  </div>

  <div class="thanks" id="thanks">
    <div class="inner">
      <h2>Thank you!</h2>
      <p>Your feedback has been recorded.</p>
      <button class="btn" id="againBtn">Done</button>
    </div>
  </div>

  <div id="netbadge">Online</div>

<script>
/* =================  CONFIG  ================= */
const CFG = {
  apiUrl: "https://script.google.com/macros/s/AKfycbzQhYlYL49anIBFrSLLTDigkf_4cZ0hW3z2zANRMVJ3jcEnLBwN3G48PhhW-H9BMK6S_A/exec
  ", // <-- CHANGE THIS
  storeId: "CL-PRETORIA-001",
  deviceLabel: "Front Counter",
  deviceId: ""
};
// optional dynamic config (won’t overwrite apiUrl)
if (location.protocol.startsWith('http')) {
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  (async()=>{
    try{
      const r = await fetch('./config.json?_=' + Date.now());
      if (r.ok){
        const cfg = await r.json();
        if (cfg.storeId)     CFG.storeId = cfg.storeId;
        if (cfg.deviceLabel) CFG.deviceLabel = cfg.deviceLabel;
        if (cfg.deviceId)    CFG.deviceId = cfg.deviceId;
      }
    }catch{}
    const f = document.getElementById('footer');
    if (f) f.textContent = (CFG.storeId||'') + ' • ' + (CFG.deviceLabel||'');
  })();
}

/* ==============  OFFLINE QUEUE v3  (idempotent)  ============== */
const OfflineQueue = (function(){
  const DB_NAME='cl-feedback-db'; const STORE='pending'; const LS='cl_feedback_pending_v3';
  let dbp=null;
  function openDB(){
    if(!('indexedDB' in window)) return Promise.resolve(null);
    if(dbp) return dbp;
    dbp=new Promise((res)=>{ const req=indexedDB.open(DB_NAME,3);
      req.onupgradeneeded=()=>{ const db=req.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:'id',autoIncrement:true}); };
      req.onsuccess=()=>res(req.result); req.onerror=()=>res(null);
    }); return dbp;
  }
  async function add(item){ item.clientId=item.clientId||(`${Date.now()}-${Math.random().toString(36).slice(2)}`);
    const db=await openDB(); if(!db){ const arr=JSON.parse(localStorage.getItem(LS)||'[]'); const _tmpId=Date.now()+Math.random(); arr.push({...item,_tmpId}); localStorage.setItem(LS,JSON.stringify(arr)); return {key:null,tmp:_tmpId}; }
    return await new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const rq=st.add(item); rq.onsuccess=()=>res({key:rq.result,tmp:null}); rq.onerror=()=>rej(rq.error); });
  }
  async function all(){ const db=await openDB(); if(!db) return JSON.parse(localStorage.getItem(LS)||'[]');
    return await new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const rq=tx.objectStore(STORE).getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error); });
  }
  async function remove(key,tmp){ const db=await openDB(); if(!db){ const arr=JSON.parse(localStorage.getItem(LS)||'[]'); const next=arr.filter(x=>x._tmpId!==tmp); localStorage.setItem(LS,JSON.stringify(next)); return; }
    await new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
  }
  return { add, all, remove };
})();

/* ==============  SENDER + FLUSH (idempotent)  ============== */
function showToast(msg){
  const el = document.getElementById('statusTxt'); el.textContent = msg;
  clearTimeout(el._t); el._t=setTimeout(()=>el.textContent='',2500);
}
async function sendNow(q){
  const r = await fetch(q.apiUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(q.body)
  });
  const txt = await r.text();
  // Accept ok:true OR duplicate:true from server
  if (!r.ok || !/\"(ok|duplicate)\"\s*:\s*(true|\"true\")/.test(txt)) {
    throw new Error('Server '+r.status+' '+txt);
  }
  return true;
}
async function flushQueue(){
  const items = await OfflineQueue.all();
  if (!items.length) return;
  for (const it of items){
    try {
      await sendNow(it);
      await OfflineQueue.remove(it.id ?? null, it._tmpId ?? null); // remove only this one
    } catch(e){
      break; // stop; keep remainder queued
    }
  }
}
function updateBadge(){
  const b=document.getElementById('netbadge'); if(!b) return;
  if(navigator.onLine){ b.textContent='Online'; b.style.background='#0a7d24'; }
  else { b.textContent='Offline (queued)'; b.style.background='#a33'; }
}
window.addEventListener('online',()=>{updateBadge();flushQueue();});
window.addEventListener('offline',updateBadge);
window.addEventListener('visibilitychange',()=>{ if(!document.hidden&&navigator.onLine) flushQueue(); });
window.addEventListener('load',()=>{ updateBadge(); if(navigator.onLine) flushQueue(); });
setInterval(()=>{ if(navigator.onLine) flushQueue(); }, 30000);

/* ==================  UI & SUBMIT  ================== */
const QUESTIONS=[
  {id:'Q1',text:'Speed of service'},
  {id:'Q2',text:'Friendliness of staff'},
  {id:'Q3',text:'Order accuracy'},
  {id:'Q4',text:'Cleanliness of store'},
  {id:'Q5',text:'Overall experience'}
];
const CHOICES=[
  {label:'😄 Excellent',score:5},
  {label:'🙂 Good',     score:4},
  {label:'😐 Average',  score:3},
  {label:'🙁 Poor',     score:2},
  {label:'😡 Bad',      score:1}
];
const qWrap=document.getElementById('questions');

function renderQuestions(){
  qWrap.innerHTML='';
  QUESTIONS.forEach(q=>{
    const el=document.createElement('div'); el.className='q';
    el.innerHTML=`
      <div class="q-label">${q.text}</div>
      <div class="grid" data-qid="${q.id}">
        ${CHOICES.map(c=>`
          <label class="choice" data-score="${c.score}">
            <input type="radio" name="${q.id}" value="${c.score}">
            <span class="emoji">${c.label.split(' ')[0]}</span>
            <span class="label">${c.label.split(' ').slice(1).join(' ')}</span>
          </label>
        `).join('')}
      </div>`;
    qWrap.appendChild(el);
  });
  qWrap.querySelectorAll('.grid').forEach(grid=>{
    grid.addEventListener('click',e=>{
      const lab = e.target.closest('.choice'); if(!lab) return;
      grid.querySelectorAll('.choice').forEach(x=>x.classList.remove('active'));
      lab.classList.add('active');
      const inp=lab.querySelector('input'); if(inp) inp.checked=true;
      updateSubmitState();
    });
  });
}
function allAnswered(){
  return QUESTIONS.every(q => !!qWrap.querySelector(`input[name="${q.id}"]:checked`));
}
function needsPOPIA(){
  return !!(document.getElementById('name').value.trim()||
            document.getElementById('surname').value.trim()||
            document.getElementById('phone').value.trim());
}
function updateSubmitState(){
  const ok = allAnswered() && (!needsPOPIA() || document.getElementById('popia').checked);
  document.getElementById('submitBtn').disabled = !ok;
}
document.addEventListener('input',e=>{
  if(['name','surname','phone','feedback','popia'].includes(e.target.id)) updateSubmitState();
});
renderQuestions(); updateSubmitState();

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  if(!allAnswered()){ showToast('Please answer all questions'); return; }
  if(needsPOPIA() && !document.getElementById('popia').checked){
    showToast('Please tick POPIA consent if you provide personal details'); return;
  }
  const answers = QUESTIONS.map(q=>{
    const score=Number(qWrap.querySelector(`input[name="${q.id}"]:checked`).value);
    const choice=CHOICES.find(c=>c.score===score);
    return {questionId:q.id,choiceLabel:choice.label,choiceScore:score};
  });
  const payload = {
    // create an idempotency key included in payload for server dedupe
    clientId: `${Date.now()}-${crypto.getRandomValues(new Uint32Array(1))[0].toString(16)}`,
    storeId: CFG.storeId,
    deviceLabel: CFG.deviceLabel,
    deviceId: CFG.deviceId || '',
    pressedAtUtc: new Date().toISOString(),
    answers,
    customer:{
      name:document.getElementById('name').value.trim(),
      surname:document.getElementById('surname').value.trim(),
      phone:document.getElementById('phone').value.trim(),
      feedback:document.getElementById('feedback').value.trim(),
      consent: document.getElementById('popia').checked || null
    }
  };

  // queue then try send
  const item = { apiUrl: CFG.apiUrl, body: payload, queuedAt: new Date().toISOString() };
  const ref = await OfflineQueue.add(item);
  try{
    await sendNow(item);
    await OfflineQueue.remove(ref.key ?? null, ref.tmp ?? null);
    document.getElementById('thanks').style.display='grid';
  }catch(e){
    showToast('Saved offline — will auto-sync ⏳');
    document.getElementById('thanks').style.display='grid';
  }

  // reset UI (but do NOT clear queue; only the sent item was removed)
  setTimeout(()=>{
    document.querySelectorAll('input[type=radio]').forEach(i=>i.checked=false);
    document.querySelectorAll('.choice').forEach(x=>x.classList.remove('active'));
    ['name','surname','phone','feedback'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('popia').checked=false;
    updateSubmitState();
  },50);
});
document.getElementById('againBtn').addEventListener('click',()=>{ document.getElementById('thanks').style.display='none'; });
</script>
</body>
</html>
